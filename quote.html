<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Vanguard Motors</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Rubik&display=swap" rel="stylesheet"> 

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark py-3 px-lg-5 d-none d-lg-block">
        <div class="row">
            <div class="col-md-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body pr-3" href=""><i class="fa fa-phone-alt mr-2"></i>+57 000 00 00</a>
                    <span class="text-body">|</span>
                    <a class="text-body px-3" href=""><i class="fa fa-envelope mr-2"></i>VanguardMotors@concessionaire.co</a>
                    <a href="LogIn.html">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill=white class="bi bi-person-circle" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                          </svg>
                    </a>
                </div>
            </div>
            <div class="col-md-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body px-3" href="">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a class="text-body px-3" href="">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a class="text-body px-3" href="">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a class="text-body px-3" href="">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a class="text-body pl-3" href="">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar Start -->
    <div class="container-fluid position-relative nav-bar p-0">
        <div class="position-relative px-lg-5" style="z-index: 9;">
            <nav class="navbar navbar-expand-lg bg-secondary navbar-dark py-3 py-lg-0 pl-3 pl-lg-5">
                <a href="" class="navbar-brand">
                    <h1 class="text-uppercase text-primary mb-1">Vanguard Motors</h1>
                </a>
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-between px-3" id="navbarCollapse">
                    <div class="navbar-nav ml-auto py-0">
                        <a href="index.html" class="nav-item nav-link">Homepage</a>
                        <a href="car.html" class="nav-item nav-link">Vehicle catalog</a>
                        <!--<a href="contact.html" class="nav-item nav-link">Contact</a>-->
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    <!-- Page Header Start -->
    <div class="container-fluid page-header">
        <h1 class="display-3 text-uppercase text-white mb-3">Vehicle Quote</h1>
        <div class="d-inline-flex text-white">
            <h6 class="text-uppercase m-0"><a class="text-white" href="index.html">Homepage</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0"><a class="text-white" href="car.html">Vehicle Catalog</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0"><a class="text-white" href="detail.html">Vehicle Details</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase text-body m-0">Vehicle Quote</h6>
        </div>
    </div>
    <!-- Page Header Start -->

    <!-- Quote Start -->
    <div class="container-fluid pt-5">
        <div class="container pt-5">
            <div class="row"> 
                <div class="col-lg-8 mb-5 mx-auto"> 
                    <form action="backend-scripts/save_quote.php" method="POST" id="quoteForm">
                        <h1 class="display-4 text-uppercase mb-4 text-center"><span id="vehicleBrandModel">Loading...</span> - Your Quotation</h1>
                        <div class="mb-4 text-center">
                            <img class="img-fluid w-100" id="vehicleImage" src="img/car-rent-6.png" alt="Vehicle Main Image" style="max-width: 600px; display: block; margin: 0 auto;">
                        </div>
                        <h3 class="text-uppercase mb-3 mt-4">Description</h3>
                        <p id="vehicleDescription">Loading vehicle description...</p>
                        
                        <h3 class="text-uppercase mb-3 mt-4">Vehicle Key Data</h3>
                        <div class="row pt-2 pb-5 border-bottom mb-5">
                            <div class="col-md-4 col-6 mb-2 d-flex align-items-center">
                                <i class="fa fa-tag text-primary mr-2"></i>
                                <span>Model Year: <span id="vehicleYear">-</span></span>
                            </div>
                            <div class="col-md-4 col-6 mb-2 d-flex align-items-center">
                                <i class="fa fa-paint-brush text-primary mr-2"></i>
                                <span>Color: <span id="vehicleColor">-</span></span>
                            </div>
                            <div class="col-md-4 col-6 mb-2 d-flex align-items-center">
                                <i class="fa fa-check-circle text-success mr-2"></i>
                                <span>Availability: <span id="vehicleAvailability">-</span></span>
                            </div>
                        </div>

                        <!-- Hidden field for vehicle_id -->
                        <input type="hidden" id="vehicle_id" name="vehicle_id" value="">

                        <h2 class="mb-4 text-uppercase text-primary">Customer Verification</h2>
                        <div class="mb-5 border-bottom pb-4">
                            <p class="alert alert-success">Your information is pre-filled. This data will be used for the quotation document.</p>
                            <div class="row px-3">
                                <div class="col-md-12 mb-3">
                                    <i class="fa fa-user text-primary mr-2"></i>
                                    <span class="font-weight-bold">Full Name:</span>
                                    <input type="text" class="form-control mt-2" id="full_name" name="full_name" readonly style="background-color: #f0f0f0;">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <i class="fa fa-envelope text-primary mr-2"></i>
                                    <span class="font-weight-bold">Email:</span>
                                    <input type="email" class="form-control mt-2" id="email" name="email" readonly style="background-color: #f0f0f0;">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <i class="fa fa-phone text-primary mr-2"></i>
                                    <span class="font-weight-bold">Phone Number:</span>
                                    <input type="text" class="form-control mt-2" id="phone_number" name="phone_number" readonly style="background-color: #f0f0f0;">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <i class="fa fa-id-card text-primary mr-2"></i>
                                    <span class="font-weight-bold">Identification:</span>
                                    <input type="text" class="form-control mt-2" id="identification_number" name="identification_number" readonly style="background-color: #f0f0f0;">
                                </div>
                            </div>
                        </div>

                        <h3 class="text-uppercase mb-3 mt-4 text-primary">Quotation Details</h3>
                        <div class="bg-light p-4 mb-4">
                            <div class="d-flex justify-content-between mb-3">
                                <h5 class="text-uppercase mb-0">Base Price:</h5>
                                <h5 class="text-primary mb-0">$<span id="displayPrice">0.00</span></h5>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <h5 class="text-uppercase mb-0">Taxes (<span id="taxPercentage">0</span>%):</h5>
                                <h5 class="text-primary mb-0">$<input type="text" id="taxes" name="taxes" class="form-control d-inline" style="width: 100px; background-color: #fff;" readonly></h5>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-3">
                                <h4 class="text-uppercase mb-0">Estimated Total:</h4>
                                <h4 class="text-primary mb-0">$<input type="text" id="total_estimated" name="total_estimated" class="form-control d-inline" style="width: 150px; background-color: #fff;" readonly></h4>
                            </div>
                            <p class="text-muted text-right mt-2 mb-0"><small>Valid until: <input type="date" id="valid_until" name="valid_until" class="form-control d-inline" style="width: 150px; background-color: #fff;" readonly></small></p>
                            
                            <div class="form-group mt-5">
                                <button type="submit" class="btn btn-primary btn-block py-3" style="font-size: 1.25rem;">
                                    <i class="fa fa-save mr-2"></i>Save Quote
                                </button>
                            </div>
                            <div class="form-group mb-0 mt-3">
                                <a href="car.html" class="btn btn-dark btn-block py-3" style="font-size: 1.25rem;">
                                    <i class="fa fa-arrow-left mr-2"></i>Back to Catalog
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Quote End-->

    <!-- Related Vehicles Section -->
    <div class="container-fluid pb-5">
        <div class="container pb-5">
            <h2 class="mb-4 text-uppercase">Related Vehicles</h2>
            <!-- Mensaje de carga -->
            <div id="loadingRelated" class="text-center py-5">
                <i class="fa fa-spinner fa-spin fa-3x text-primary"></i>
                <p class="mt-3">Loading related vehicles...</p>
            </div>
            <!-- Mensaje si no hay veh√≠culos -->
            <div id="noRelatedVehicles" class="alert alert-info text-center" style="display:none;">
                <i class="fa fa-info-circle mr-2"></i>No related vehicles found at this time.
            </div>
            <!-- Carrusel de veh√≠culos -->
            <div class="owl-carousel related-carousel" id="relatedCarousel" style="display:none;">
                <!-- Los veh√≠culos se cargar√°n din√°micamente aqu√≠ -->
            </div>
        </div>
    </div>
    <style>
    .vehicle-card {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
        margin: 10px;
    }

    .vehicle-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 40px rgba(0, 0, 0, 0.15);
    }

    .vehicle-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .vehicle-card .card-body {
        padding: 20px;
    }

    .related-carousel .owl-nav {
        margin-top: 20px;
    }

    .related-carousel .owl-nav button {
        width: 50px;
        height: 50px;
        background: var(--primary) !important;
        color: #fff !important;
        border-radius: 50%;
        font-size: 22px;
        line-height: 50px;
        margin: 0 5px;
    }

    .related-carousel .owl-nav button:hover {
        background: var(--dark) !important;
    }

    .related-carousel .owl-dots {
        margin-top: 20px;
        text-align: center;
    }

    .related-carousel .owl-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        background: #ddd;
        border-radius: 50%;
        margin: 0 5px;
    }

    .related-carousel .owl-dot.active {
        background: var(--primary);
    }
    </style>
    <!-- Related Vehicle End -->

    <!-- Vendor Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="owl-carousel vendor-carousel">
                <div class="bg-light p-4">
                    <img src="img/vendor-1.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-2.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-3.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-4.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-5.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-6.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-7.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-8.png" alt="">
                </div>
            </div>
        </div>
    </div>
    <!-- Vendor End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-secondary py-5 px-sm-3 px-md-5" style="margin-top: 90px;">
        <div class="row pt-5">
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Get In Touch</h4>
                <p class="mb-2"><i class="fa fa-map-marker-alt text-white mr-3"></i>Poblado, Medell√≠n</p>
                <p class="mb-2"><i class="fa fa-phone-alt text-white mr-3"></i>+57 000 00 00</p>
                <p><i class="fa fa-envelope text-white mr-3"></i>info@concessionaire.co</p>
                <h6 class="text-uppercase text-white py-2">Follow Us</h6>
                <div class="d-flex justify-content-start">
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-twitter"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square" href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <!--usefull links: poner algunos servicios como mantenimiento, reparaci√≥n y que redireccione directamente al chat de contactenos-->
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Usefull Links</h4>
                <div class="d-flex flex-column justify-content-start">
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Private Policy</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Term & Conditions</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>New Member Registration</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Affiliate Programme</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Return & Refund</a>
                    <a class="text-body" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Help & FQAs</a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Vahicle Gallery</h4>
                <div class="row mx-n1">
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-1.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-2.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-3.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-4.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-5.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-6.jpg" alt=""></a>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Newsletter</h4>
                <p class="mb-4">If you see any problems with the page, please let us know or tell us about your experience with us.</p>
                <div class="w-100 mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark border-dark" style="padding: 25px;" placeholder="Write here">
                        <div class="input-group-append">
                            <button class="btn btn-primary text-uppercase px-3">Send</button>
                        </div>
                    </div>
                </div>
                <i>We will read your message instantly.</i>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark py-4 px-sm-3 px-md-5">
        <p class="mb-2 text-center text-body">&copy; <a href="#">VanguardMotors</a>. All Rights Reserved.</p>
        <p class="m-0 text-center text-body">Designed by <a href="">K2ES SD</a></p>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <!-- Quote Form Handler -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const vehicleId = urlParams.get('vehicle_id');
    if (vehicleId) {
        document.getElementById('vehicle_id').value = vehicleId;
        fetch(`backend-scripts/get_quote_data.php?vehicle_id=${vehicleId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Llenar datos del veh√≠culo
                    document.getElementById('vehicleBrandModel').textContent = 
                        `${data.vehicle.brand} ${data.vehicle.model}`;
                    document.getElementById('vehicleImage').src = data.vehicle.image;
                    document.getElementById('vehicleDescription').textContent = 
                        data.vehicle.description;
                    document.getElementById('vehicleYear').textContent = data.vehicle.year;
                    document.getElementById('vehicleColor').textContent = data.vehicle.color;
                    document.getElementById('vehicleAvailability').textContent = data.vehicle.availability;
                    document.getElementById('displayPrice').textContent = 
                        parseFloat(data.vehicle.price).toLocaleString('en-US', {minimumFractionDigits: 2});
                    // Llenar datos del cliente
                    if (data.person) {
                        document.getElementById('full_name').value = data.person.full_name || '';
                        document.getElementById('email').value = data.person.email || '';
                        document.getElementById('phone_number').value = data.person.phone_number || '';
                        document.getElementById('identification_number').value = 
                            data.person.identification_number || '';
                    }
                    // Calcular cotizaci√≥n
                    const basePrice = parseFloat(data.vehicle.price);
                    const taxPercentage = data.taxPercentage || 19;
                    const taxes = (basePrice * taxPercentage / 100).toFixed(2);
                    const totalEstimated = (basePrice + parseFloat(taxes)).toFixed(2);
                    const validUntil = new Date();
                    validUntil.setDate(validUntil.getDate() + 30);
                    document.getElementById('taxPercentage').textContent = taxPercentage;
                    document.getElementById('taxes').value = taxes;
                    document.getElementById('total_estimated').value = totalEstimated;
                    document.getElementById('valid_until').value = validUntil.toISOString().split('T')[0];
                    
                    // ‚úÖ‚úÖ‚úÖ AQU√ç VA LA VALIDACI√ìN DE DISPONIBILIDAD ‚úÖ‚úÖ‚úÖ
                    console.log('üîç Verificando disponibilidad:', data.vehicle.is_available);
                    console.log('üìä Estado del veh√≠culo:', data.vehicle.availability_status);
                    if (!data.vehicle.is_available) {
                        const submitBtn = document.querySelector('#quoteForm button[type="submit"]');
                        const availabilityStatus = data.vehicle.availability_status;
                        const statusMessages = {
                            'sold': 'üö´ This vehicle has been SOLD',
                            'reserved': '‚ö†Ô∏è This vehicle is RESERVED',
                            'unavailable': '‚ùå This vehicle is UNAVAILABLE'
                        };
                        const statusDescriptions = {
                            'sold': 'This vehicle has been sold and is no longer available for quotes or reservations.',
                            'reserved': 'This vehicle is currently reserved by another customer.',
                            'unavailable': 'This vehicle is temporarily unavailable.'
                        };
                        const message = statusMessages[availabilityStatus] || '‚ùå NOT AVAILABLE';
                        const description = statusDescriptions[availabilityStatus] || 'This vehicle is not available.';
                        // Deshabilitar bot√≥n y cambiar apariencia
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = `<i class="fa fa-ban mr-2"></i>${message}`;
                        submitBtn.classList.remove('btn-primary');
                        submitBtn.classList.add('btn-secondary');
                        // Crear alerta de advertencia
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning mt-4';
                        alertDiv.innerHTML = `
                            <h5 class="mb-3">
                                <i class="fa fa-exclamation-triangle mr-2"></i>Vehicle Not Available
                            </h5>
                            <p class="mb-0">
                                ${description} You can view the quote information but cannot save it or make a reservation at this time.
                            </p>
                        `;
                        // Insertar alerta ANTES del bot√≥n
                        submitBtn.parentNode.insertBefore(alertDiv, submitBtn);
                        console.log('‚úÖ Bot√≥n deshabilitado y alerta mostrada');
                    } else {
                        console.log('‚úÖ Veh√≠culo disponible - bot√≥n activo');
                    }
                    // ‚úÖ‚úÖ‚úÖ FIN DE LA VALIDACI√ìN ‚úÖ‚úÖ

                    // ‚úÖ CARGAR VEH√çCULOS RELACIONADOS
                    loadRelatedVehicles(vehicleId);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message
                    }).then(() => window.location.href = 'car.html');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Connection Error',
                    text: 'Error loading quote data'
                }).then(() => window.location.href = 'car.html');
            });
    } else {
        Swal.fire({
            icon: 'warning',
            title: 'No Vehicle Selected',
            text: 'Please select a vehicle from the catalog'
        }).then(() => window.location.href = 'car.html');
    }

    // MANEJO DEL ENV√çO DEL FORMULARIO
    document.getElementById('quoteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>Processing...';
        const formData = new FormData(this);
        fetch('backend-scripts/save_quote.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¬°Quote Saved Successfully!',
                    html: `
                        <div class="text-left">
                            <p class="mb-3"><strong>Your quotation has been processed!</strong></p>
                            <hr>
                            <h5 class="text-primary mb-3"><i class="fas fa-envelope mr-2"></i>Email Notification</h5>
                            <p>A detailed quote for the <strong>${data.appointment.vehicle}</strong> will be sent to:</p>
                            <p class="text-center bg-light p-2 rounded"><strong>${data.customer.email}</strong></p>
                            
                            <hr>
                            <h5 class="text-success mb-3"><i class="fas fa-calendar-check mr-2"></i>Appointment Scheduled</h5>
                            <p>We've automatically scheduled a consultation appointment to review your quote:</p>
                            <ul class="list-unstyled mt-3 bg-light p-3 rounded">
                                <li class="mb-2"><i class="fas fa-calendar text-primary mr-2"></i><strong>Date:</strong> ${data.appointment.date}</li>
                                <li class="mb-2"><i class="fas fa-clock text-primary mr-2"></i><strong>Time:</strong> ${data.appointment.time}</li>
                                <li><i class="fas fa-user-tie text-primary mr-2"></i><strong>Advisor:</strong> ${data.appointment.advisor}</li>
                            </ul>
                            
                            <div class="alert alert-info mt-3 mb-0">
                                <small><i class="fas fa-info-circle mr-2"></i>You will receive a confirmation email with all the details shortly.</small>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '<i class="fas fa-car mr-2"></i>Back to Catalog',
                    confirmButtonColor: '#007bff',
                    allowOutsideClick: false,
                    width: '600px'
                }).then(() => {
                    window.location.href = 'car.html';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error Saving Quote',
                    text: data.message,
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Connection Error',
                text: 'Could not save quote. Please try again.',
                confirmButtonText: 'OK'
            });
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
});

// =====================================================================
// FUNCIONES PARA VEH√çCULOS RELACIONADOS
// =====================================================================

function loadRelatedVehicles(vehicleId) {
    console.log('Loading related vehicles for vehicle ID:', vehicleId);
    
    fetch(`backend-scripts/get_related_vehicles.php?vehicle_id=${vehicleId}`)
        .then(response => response.json())
        .then(data => {
            // ‚úÖ OCULTAR LOADING SIEMPRE AL INICIO
            document.getElementById('loadingRelated').style.display = 'none';
            
            console.log('üì¶ Respuesta completa del servidor:', data);
            
            // ‚úÖ DEBUG: Ver cada veh√≠culo y su imagen
            if (data.success && data.related_vehicles) {
                console.log('üöó Total de veh√≠culos relacionados:', data.related_vehicles.length);
                data.related_vehicles.forEach((v, index) => {
                    console.log(`
                        Veh√≠culo ${index + 1}:
                        - ID: ${v.vehicle_id}
                        - Marca/Modelo: ${v.brand} ${v.model}
                        - Imagen: ${v.image}
                        - Imagen existe: ${v.image !== 'img/car-placeholder.png' ? '‚úÖ' : '‚ùå'}
                    `);
                });
            }
            
            if (data.success && data.related_vehicles && data.related_vehicles.length > 0) {
                const carousel = document.getElementById('relatedCarousel');
                carousel.innerHTML = ''; // Limpiar
                
                // Crear cards
                data.related_vehicles.forEach(vehicle => {
                    const vehicleCard = createVehicleCard(vehicle);
                    carousel.innerHTML += vehicleCard;
                });
                
                // Mostrar y activar carrusel
                carousel.style.display = 'block';
                
                // Destruir carrusel anterior si existe
                if ($('.related-carousel').data('owl.carousel')) {
                    $('.related-carousel').trigger('destroy.owl.carousel');
                    $('.related-carousel').removeClass('owl-loaded');
                }
                
                // Inicializar Owl Carousel
                $('.related-carousel').owlCarousel({
                    autoplay: true,
                    autoplayTimeout: 5000,
                    autoplayHoverPause: true,
                    smartSpeed: 1000,
                    margin: 30,
                    dots: true,
                    loop: data.related_vehicles.length > 1,
                    nav: true,
                    navText: [
                        '<i class="fa fa-angle-left" aria-hidden="true"></i>',
                        '<i class="fa fa-angle-right" aria-hidden="true"></i>'
                    ],
                    responsive: {
                        0: { items: 1 },
                        576: { items: 1 },
                        768: { items: 2 },
                        992: { items: 3 }
                    }
                });
                
                console.log('Carousel initialized with', data.related_vehicles.length, 'vehicles');
                
            } else {
                document.getElementById('noRelatedVehicles').style.display = 'block';
                console.log('No related vehicles found');
            }
        })
        .catch(error => {
            console.error('Error loading related vehicles:', error);
            document.getElementById('loadingRelated').style.display = 'none'; // ‚úÖ Tambi√©n aqu√≠
            document.getElementById('noRelatedVehicles').style.display = 'block';
        });
}

function createVehicleCard(vehicle) {
    const availabilityMap = {
        'available': { text: 'Available', class: 'text-success', icon: 'check-circle' },
        'reserved': { text: 'Reserved', class: 'text-warning', icon: 'clock' },
        'sold': { text: 'Sold', class: 'text-danger', icon: 'times-circle' },
        'unavailable': { text: 'Unavailable', class: 'text-secondary', icon: 'ban' }
    };
    
    const availability = availabilityMap[vehicle.availability] || { 
        text: 'Unknown', 
        class: 'text-muted', 
        icon: 'question-circle' 
    };
    
    const formattedPrice = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(vehicle.price);
    
    return `
        <div class="vehicle-card">
            <img src="${vehicle.image}" 
                 alt="${vehicle.brand} ${vehicle.model}"
                 onerror="this.onerror=null; this.src='img/car-placeholder.png';"
                 style="width: 100%; height: 200px; object-fit: cover;">
            <div class="card-body text-center">
                <h4 class="text-uppercase mb-2">${vehicle.brand} ${vehicle.model}</h4>
                <h5 class="text-primary mb-3">${formattedPrice}</h5>
                <div class="d-flex justify-content-center mb-3">
                    <div class="px-2">
                        <i class="fa fa-calendar-alt text-primary mr-1"></i>
                        <span class="small">${vehicle.year}</span>
                    </div>
                    <div class="px-2 border-left border-right">
                        <i class="fa fa-paint-brush text-primary mr-1"></i>
                        <span class="small">${vehicle.color}</span>
                    </div>
                    <div class="px-2">
                        <i class="fa fa-${availability.icon} ${availability.class} mr-1"></i>
                        <span class="small">${availability.text}</span>
                    </div>
                </div>
                <a class="btn btn-primary px-4 py-2" href="detail.html?vehicle_id=${vehicle.vehicle_id}">
                    <i class="fa fa-eye mr-2"></i>See Details
                </a>
            </div>
        </div>
    `;
}
</script>
</body>
</html>