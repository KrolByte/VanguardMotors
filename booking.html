<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Vanguard Motors</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Rubik&display=swap" rel="stylesheet"> 
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">
    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />
    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark py-3 px-lg-5 d-none d-lg-block">
        <div class="row">
            <div class="col-md-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body pr-3" href=""><i class="fa fa-phone-alt mr-2"></i>+57 000 00 00</a>
                    <span class="text-body">|</span>
                    <a class="text-body px-3" href=""><i class="fa fa-envelope mr-2"></i>VanguardMotors@concessionaire.co</a>
                    <a href="LogIn.html">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill=white class="bi bi-person-circle" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                          </svg>
                    </a>
                </div>
            </div>
            <div class="col-md-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body px-3" href="https://www.facebook.com/tu-pagina" target="_blank">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a class="text-body px-3" href="https://www.twitter.com/tu-usuario" target="_blank">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a class="text-body px-3" href="https://www.linkedin.com/in/tu-perfil" target="_blank">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a class="text-body px-3" href="https://www.instagram.com/tu-usuario" target="_blank">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a class="text-body pl-3" href="https://www.youtube.com/tu-canal" target="_blank">
                        <i class="fab fa-youtube"></i>
                    </a>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar Start -->
    <div class="container-fluid position-relative nav-bar p-0">
        <div class="position-relative px-lg-5" style="z-index: 9;">
            <nav class="navbar navbar-expand-lg bg-secondary navbar-dark py-3 py-lg-0 pl-3 pl-lg-5">
                <a href="" class="navbar-brand">
                    <h1 class="text-uppercase text-primary mb-1">Vanguard Motors</h1>
                </a>
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-between px-3" id="navbarCollapse">
                    <div class="navbar-nav ml-auto py-0">
                        <a href="index.html" class="nav-item nav-link">Homepage</a>
                        <a href="car.html" class="nav-item nav-link">Vehicle catalog</a>
                        <!--<a href="contact.html" class="nav-item nav-link">Contact</a>-->
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    <!-- Page Header Start -->
    <div class="container-fluid page-header">
        <h1 class="display-3 text-uppercase text-white mb-3">Vehicle Reserve</h1>
        <div class="d-inline-flex text-white">
            <h6 class="text-uppercase m-0"><a class="text-white" href="index.html">Homepage</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0"><a class="text-white" href="car.html">Vehicle Catalog</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0"><a class="text-white" href="detail.html">Vehicle Details</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase text-body m-0">Vehicle Reserve</h6>
        </div>
    </div>
    <!-- Page Header Start -->

    <!-- Car Booking Start -->
    <div id="reservationBanner" class="alert alert-info text-center" role="alert" style="display:none; position:fixed; top:90px; left:50%; transform:translateX(-50%); z-index:1060; width:90%; max-width:600px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
        <strong>Processing...</strong> Please wait.
    </div>
    <div class="container-fluid pb-5">
        <div class="container">
            <div class="row">
                <!-- COLUMNA PRINCIPAL: FORMULARIO -->
                <div class="col-lg-8">
                    <form id="reservationForm" method="POST">
                        <input type="hidden" name="vehicle_id" value="">
                        <input type="hidden" name="person_id" value=""> 
                        
                        <!-- ============================================ -->
                        <!-- PASO 1: DATOS DE RESERVA -->
                        <!-- ============================================ -->
                        <div id="step1-reservation" class="reservation-step">
                            <h2 class="mb-4 text-uppercase text-primary">
                                <i class="fas fa-user-circle mr-2"></i>1. Your personal data
                            </h2>
                            <div class="mb-5 border-bottom pb-4">
                                <p class="alert alert-success">
                                    <i class="fas fa-info-circle mr-2"></i>Your information is pre-filled. Please confirm your phone number.
                                </p>
                                <div class="row">
                                    <div class="col-6 form-group">
                                        <label for="fullName">Full Name</label>
                                        <input type="text" id="fullName" class="form-control p-4 bg-light" value="" readonly required>
                                    </div>
                                    <div class="col-6 form-group">
                                        <label for="identification">Identification</label>
                                        <input type="text" id="identification" class="form-control p-4 bg-light" value="" readonly required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6 form-group">
                                        <label for="email">Email</label>
                                        <input type="email" id="email" class="form-control p-4 bg-light" value="" readonly required>
                                    </div>
                                    <div class="col-6 form-group">
                                        <label for="phone">Phone number<span class="text-danger">*</span></label>
                                        <input type="tel" id="phone" class="form-control p-4" placeholder="Your phone number" name="customer_phone" required>
                                    </div>
                                </div>
                            </div>
                            <h2 class="mb-4 text-uppercase text-primary">
                                <i class="fas fa-calendar-alt mr-2"></i>2. Schedule your appointment
                            </h2>
                            <div class="mb-5 border-bottom pb-4">
                                <!-- PRIMERO: Fecha y Hora -->
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label for="dateReserva">Appointment date<span class="text-danger">*</span></label>
                                            <div class="date" id="date-reserva" data-target-input="nearest">
                                                <input type="text" id="dateReserva" class="form-control p-4 datetimepicker-input" placeholder="Select date" data-target="#date-reserva" data-toggle="datetimepicker" name="appointment_date" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <label for="timeReserva">Appointment time<span class="text-danger">*</span></label>
                                            <div class="time" id="time-reserva" data-target-input="nearest">
                                                <input type="text" id="timeReserva" class="form-control p-4 datetimepicker-input" placeholder="Select time" data-target="#time-reserva" data-toggle="datetimepicker" name="appointment_time" required />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- DESPU√âS: Asesor (filtrado por disponibilidad) -->
                                <div class="row">
                                    <div class="col-md-6 form-group">
                                        <label for="advisorSelect">Select Advisor<span class="text-danger">*</span></label>
                                        <select id="advisorSelect" class="custom-select px-4" style="height: 50px;" name="advisor_id" required disabled>
                                            <option value="" disabled selected>First select date and time</option>
                                        </select>
                                        <small class="form-text text-muted">Only available advisors for the selected time will appear</small>
                                    </div>
                                    <div class="col-md-6 form-group">
                                        <label for="reservationPrice">Reservation amount</label>
                                        <input type="text" id="reservationPrice" class="form-control p-4 bg-light" value="$20.000 COP" readonly>
                                        <small class="form-text text-muted">Fixed non-refundable amount</small>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="btnContinuePayment" class="btn btn-block btn-primary py-3">
                                <i class="fas fa-arrow-right mr-2"></i>CONTINUE TO PAYMENT
                            </button>
                        </div>
                        
                        <!-- ============================================ -->
                        <!-- PASO 2: PAGO -->
                        <!-- ============================================ -->
                        <div id="step2-payment" class="payment-step" style="display:none;">
                            <button type="button" class="btn btn-outline-secondary mb-4" onclick="goBackToReservation()">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Reservation
                            </button>
                            <h2 class="mb-4 text-uppercase text-primary">
                                <i class="fas fa-credit-card mr-2"></i>3. Payment Information
                            </h2>
                            <div class="mb-5">
                                <div class="form-group">
                                    <label for="paymentMethod">Payment method<span class="text-danger">*</span></label>
                                    <select id="paymentMethod" class="custom-select px-4" style="height: 50px;" name="payment_method" required>
                                        <option value="" disabled selected>Select payment option</option>
                                        <option value="card">Credit/Debit card</option>
                                        <option value="transfer">Bank transfer</option>
                                    </select>
                                </div>
                                <!-- CAMPOS DE TARJETA -->
                                <div id="cardDetails" style="display: none;">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-info-circle mr-2"></i><strong>PAYMENT SIMULATION:</strong> Card data is collected to generate payment reference.
                                    </div>
                                    <div class="row">
                                        <div class="col-12 form-group">
                                            <label>Card number</label>
                                            <input type="text" class="form-control p-4" placeholder="1234 5678 9012 3456" name="card_number" maxlength="19" pattern="[0-9\s]*">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6 form-group">
                                            <label>Expiration date (MM/YY)</label>
                                            <input type="text" class="form-control p-4" placeholder="12/25" name="issue_date" maxlength="5" pattern="[0-9/]*">
                                        </div>
                                        <div class="col-6 form-group">
                                            <label>Security code (CVV)</label>
                                            <input type="text" class="form-control p-4" placeholder="123" name="card_code" maxlength="4" pattern="[0-9]*">
                                        </div>
                                    </div>
                                </div>
                                <!-- CAMPOS DE TRANSFERENCIA -->
                                <div id="transferDetails" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-university mr-2"></i><strong>Bank Transfer:</strong> Your reservation will be in <strong>PENDING</strong> status until verified.
                                    </div>
                                    <div class="form-group">
                                        <label>Transfer reference number</label>
                                        <input type="text" class="form-control p-4" placeholder="Enter transfer reference number" name="reference_number">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-block btn-success py-3">
                                <i class="fas fa-check-circle mr-2"></i>CONFIRM RESERVATION AND PAY
                            </button>
                        </div>
                    </form>
                </div>
                <!-- COLUMNA LATERAL: RESUMEN -->
                <div class="col-lg-4">
                    <div class="bg-secondary p-5 mb-5 sticky-top" style="top: 100px;">
                        <h4 class="text-primary mb-4 text-uppercase">
                            <i class="fas fa-file-invoice mr-2"></i>Reservation Summary
                        </h4>
                        <!-- Veh√≠culo -->
                        <div class="text-center mb-4 border-bottom pb-3">
                            <img id="summaryVehicleImage" class="img-fluid mb-3" src="img/car-placeholder.png" alt="Vehicle" style="max-height: 150px; object-fit: cover; border-radius: 8px;">
                            <h5 id="summaryVehicleModel" class="text-white text-uppercase mb-0">Loading...</h5>
                            <p id="summaryVehicleMeta" class="text-white-50">Year / Color</p>
                        </div>
                        <!-- Cliente y Cita -->
                        <div class="mb-4 border-bottom pb-3">
                            <h6 class="text-white mb-2">
                                <i class="fas fa-user mr-2"></i>Client: 
                                <span id="summaryCustomerName" class="float-right">Loading...</span>
                            </h6>
                            <h6 class="text-white mb-2">
                                <i class="fas fa-clock mr-2"></i>Appointment: 
                                <span id="summaryDateTime" class="float-right text-warning">Select Date & Time</span>
                            </h6>
                            <h6 class="text-white mb-0">
                                <i class="fas fa-user-tie mr-2"></i>Advisor: 
                                <span id="summaryAdvisorName" class="float-right text-success">Select Date & Time first</span>
                            </h6>
                        </div>
                        <!-- Precio -->
                        <div class="mb-4 border-bottom pb-3">
                            <h5 class="text-uppercase mb-3">
                                <i class="fas fa-money-bill-wave mr-2"></i>Deposit Details
                            </h5>
                            <h6 class="text-white mb-2">
                                Reservation amount: 
                                <span class="float-right text-success font-weight-bold">$20.000 COP</span>
                            </h6>
                            <h6 class="text-white mb-0 text-danger">
                                Condition: 
                                <span class="float-right font-weight-bold">NON-REFUNDABLE</span>
                            </h6>
                        </div>
                        <!-- Total -->
                        <div class="mb-4">
                            <h4 class="text-primary text-uppercase">
                                Total to pay: 
                                <span class="float-right">$20.000</span>
                            </h4>
                        </div>
                        <p class="small text-white-50 text-center pt-3">
                            <i class="fas fa-shield-alt mr-2"></i>This payment guarantees your appointment and is non-refundable.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSS ADICIONAL -->
    <style>
    .reservation-step, .payment-step {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .sticky-top {
        position: -webkit-sticky;
        position: sticky;
    }
    </style>
    <!--Car Booking End-->

    <!-- Vendor Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="owl-carousel vendor-carousel">
                <div class="bg-light p-4">
                    <img src="img/vendor-1.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-2.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-3.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-4.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-5.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-6.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-7.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-8.png" alt="">
                </div>
            </div>
        </div>
    </div>
    <!-- Vendor End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-secondary py-5 px-sm-3 px-md-5" style="margin-top: 90px;">
        <div class="row pt-5">
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Get In Touch</h4>
                <p class="mb-2"><i class="fa fa-map-marker-alt text-white mr-3"></i>Poblado, Medell√≠n</p>
                <p class="mb-2"><i class="fa fa-phone-alt text-white mr-3"></i>+57 000 00 00</p>
                <p><i class="fa fa-envelope text-white mr-3"></i>info@concessionaire.co</p>
                <h6 class="text-uppercase text-white py-2">Follow Us</h6>
                <div class="d-flex justify-content-start">
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-twitter"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square" href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <!--usefull links: poner algunos servicios como mantenimiento, reparaci√≥n y que redireccione directamente al chat de contactenos-->
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Usefull Links</h4>
                <div class="d-flex flex-column justify-content-start">
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Private Policy</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Term & Conditions</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>New Member Registration</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Affiliate Programme</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Return & Refund</a>
                    <a class="text-body" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Help & FQAs</a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Vahicle Gallery</h4>
                <div class="row mx-n1">
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-1.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-2.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-3.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-4.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-5.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-6.jpg" alt=""></a>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Newsletter</h4>
                <p class="mb-4">If you see any problems with the page, please let us know or tell us about your experience with us.</p>
                <div class="w-100 mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark border-dark" style="padding: 25px;" placeholder="Write here">
                        <div class="input-group-append">
                            <button class="btn btn-primary text-uppercase px-3">Send</button>
                        </div>
                    </div>
                </div>
                <i>We will read your message instantly.</i>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark py-4 px-sm-3 px-md-5">
        <p class="mb-2 text-center text-body">&copy; <a href="#">VanguardMotors</a>. All Rights Reserved.</p>
        <p class="m-0 text-center text-body">Designed by <a href="">K2ES SD</a></p>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    <script>
    /* ===============================================================
    CONFIGURACI√ìN Y VARIABLES GLOBALES
    ================================================================ */
    const RESERVATION_PRICE = 20000;
    const API_URLS = {
        vehicle: 'backend-scripts/get_vehicle_detail.php',
        advisors: 'backend-scripts/get_advisors.php',
        availability: 'backend-scripts/get_advisor_availability.php',
        userData: 'backend-scripts/get_logged_user_data.php',
        createReservation: 'backend-scripts/create_reservation.php'
    };

    let vehicleData = {};
    let clientData = {};
    let allAdvisors = [];
    let bookedDates = {};
    let advisorSelectInitialized = false;

    // ‚úÖ Horas permitidas: solo en punto y media hora
    const allowedMinutes = [0, 30];
    const allowedHours = [9, 10, 11, 14, 15, 16, 17];

    /* ===============================================================
    1. INICIALIZACI√ìN
    ================================================================ */
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const vehicleId = urlParams.get('vehicle_id');

        if (!vehicleId) {
            showError("Error: No vehicle ID provided in URL.", true);
            return;
        }

        // Cargar datos iniciales
        checkUserSessionAndLoadData();
        loadVehicleData(vehicleId);
        loadAllAdvisors();
        setupPaymentToggle();

        // Inicializar DateTimePickers
        $(document).ready(() => {
            setupDateTimePickers();
        });

        // Configurar bot√≥n de continuar al pago
        document.getElementById('btnContinuePayment').addEventListener('click', goToPaymentStep);

        // Configurar env√≠o del formulario
        setupFormSubmission();
    });

    /* ===============================================================
    2. NAVEGACI√ìN ENTRE PASOS
    ================================================================ */
    function goToPaymentStep() {
        // Validar campos del paso 1
        const phone = document.getElementById('phone').value.trim();
        const date = document.getElementById('dateReserva').value;
        const time = document.getElementById('timeReserva').value;
        const advisorId = document.getElementById('advisorSelect').value;

        if (!phone) {
            showError("Please enter your phone number.", false);
            document.getElementById('phone').focus();
            return;
        }

        if (!date) {
            showError("Please select an appointment date.", false);
            return;
        }

        if (!time) {
            showError("Please select an appointment time.", false);
            return;
        }

        if (!advisorId) {
            showError("Please select an advisor.", false);
            return;
        }

        // Ocultar paso 1, mostrar paso 2
        document.getElementById('step1-reservation').style.display = 'none';
        document.getElementById('step2-payment').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.getElementById('reservationBanner').style.display = 'none';
    }

    function goBackToReservation() {
        document.getElementById('step2-payment').style.display = 'none';
        document.getElementById('step1-reservation').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ===============================================================
    3. CARGA DE DATOS DEL USUARIO
    ================================================================ */
    function checkUserSessionAndLoadData() {
        const banner = document.getElementById('reservationBanner');
        banner.innerHTML = '<strong>Loading user data...</strong>';
        banner.className = 'alert alert-info text-center';
        banner.style.display = 'block';

        fetch(API_URLS.userData)
            .then(resp => {
                if (!resp.ok) throw new Error("Network error");
                return resp.json();
            })
            .then(json => {
                console.log('‚úÖ User data:', json);

                if (json.success && json.is_logged_in && json.data) {
                    clientData = json.data;
                    populateClientData(clientData);
                    banner.style.display = 'none';
                } else {
                    showError("You must be logged in to make a reservation.", true);
                }
            })
            .catch(error => {
                showError(`Error loading user data: ${error.message}`, true);
                console.error('‚ùå User error:', error);
            });
    }

    function populateClientData(data) {
        document.getElementById('fullName').value = data.full_name || 'N/A';
        document.getElementById('identification').value = data.identification || 'N/A';
        document.getElementById('email').value = data.email || 'N/A';

        if (document.getElementById('phone').value === '') {
            document.getElementById('phone').value = data.phone || '';
        }

        document.querySelector('input[name="person_id"]').value = data.person_id || '';
        document.getElementById('summaryCustomerName').textContent = data.full_name || 'N/A';
    }

    /* ===============================================================
    4. CARGA DE VEH√çCULO CON VALIDACI√ìN DE ESTADO
    ================================================================ */
    function loadVehicleData(vehicleId) {
        document.getElementById('summaryVehicleModel').textContent = 'Loading vehicle...';

        fetch(API_URLS.vehicle + '?vehicle_id=' + vehicleId)
            .then(resp => {
                if (!resp.ok) throw new Error("Network error");
                return resp.json();
            })
            .then(json => {
                console.log('‚úÖ Vehicle data:', json);

                if (json.success && json.data) {
                    vehicleData = json.data;
                    document.querySelector('input[name="vehicle_id"]').value = vehicleId;

                    const imageUrl = vehicleData.images && vehicleData.images.length > 0
                        ? vehicleData.images[0]
                        : 'img/car-placeholder.png';

                    document.getElementById('summaryVehicleImage').src = imageUrl;
                    document.getElementById('summaryVehicleModel').textContent = `${vehicleData.brand} ${vehicleData.model}`;
                    document.getElementById('summaryVehicleMeta').textContent = `Year ${vehicleData.year} / Color ${vehicleData.color}`;

                    // ‚úÖ VALIDACI√ìN DE ESTADO DEL VEH√çCULO (usando 'availability')
                    console.log('üîç Vehicle availability received:', vehicleData.availability);
                    validateVehicleStatus(vehicleData.availability);
                    
                } else {
                    showError("Vehicle not found.", true);
                }
            })
            .catch(error => {
                showError(`Error loading vehicle: ${error.message}`, true);
                console.error('‚ùå Vehicle error:', error);
            });
    }

    /* ===============================================================
    4.1 VALIDAR ESTADO DEL VEH√çCULO
    ================================================================ */
    function validateVehicleStatus(availability) {
        const btnContinuePayment = document.getElementById('btnContinuePayment');
        const summarySection = document.querySelector('.col-lg-4 .bg-secondary');
        const banner = document.getElementById('reservationBanner');
        
        // Validar que availability exista
        if (!availability || availability === undefined || availability === null) {
            console.warn('‚ö†Ô∏è Vehicle availability is undefined - assuming available');
            availability = 'Available'; // Valor por defecto
        }
        
        // Normalizar el estado a min√∫sculas para comparaci√≥n
        const normalizedAvailability = String(availability).toLowerCase().trim();
        
        if (normalizedAvailability !== 'available' && normalizedAvailability !== 'disponible') {
            // ‚ùå VEH√çCULO NO DISPONIBLE
            
            // Deshabilitar bot√≥n de continuar
            btnContinuePayment.disabled = true;
            btnContinuePayment.innerHTML = '<i class="fas fa-ban mr-2"></i>VEHICLE NOT AVAILABLE';
            btnContinuePayment.classList.remove('btn-primary');
            btnContinuePayment.classList.add('btn-secondary');
            
            // Mostrar mensaje de error persistente
            let statusMessage = '';
            let statusIcon = '';

            switch(normalizedAvailability) {
                case 'en mantenimiento':
                case 'maintenance':
                case 'under maintenance':
                case 'unavailable':
                case 'no disponible':
                    statusMessage = 'This vehicle is currently unavailable and cannot be reserved.';
                    statusIcon = 'fas fa-ban';
                    break;
                case 'vendido':
                case 'sold':
                    statusMessage = 'This vehicle has been sold and is no longer available.';
                    statusIcon = 'fas fa-check-circle';
                    break;
                case 'reservado':
                case 'reserved':
                    statusMessage = 'This vehicle is already reserved by another customer.';
                    statusIcon = 'fas fa-calendar-check';
                    break;
                case 'not available':
                    statusMessage = 'This vehicle is not available for reservation at the moment.';
                    statusIcon = 'fas fa-ban';
                    break;
                default:
                    statusMessage = `This vehicle is not available for reservation (Status: ${availability}).`;
                    statusIcon = 'fas fa-exclamation-triangle';
            }
            
            banner.className = 'alert alert-danger text-center';
            banner.innerHTML = `
                <i class="${statusIcon} mr-2"></i>
                <strong>Vehicle Not Available</strong>
                <p class="mb-0 mt-2">${statusMessage}</p>
            `;
            banner.style.display = 'block';
            
            // Agregar badge de estado en el resumen
            const statusBadge = document.createElement('div');
            statusBadge.className = 'alert alert-danger mt-3 mb-0';
            statusBadge.innerHTML = `
                <i class="${statusIcon} mr-2"></i>
                <strong>Status:</strong> ${availability.toUpperCase()}
            `;
            
            const vehicleInfoSection = summarySection.querySelector('.text-center.mb-4');
            if (vehicleInfoSection && !vehicleInfoSection.querySelector('.alert-danger')) {
                vehicleInfoSection.appendChild(statusBadge);
            }
            
            // Deshabilitar tambi√©n el formulario
            disableReservationForm();
            
            console.log('‚ùå Vehicle not available for reservation:', availability);
            
        } else {
            // ‚úÖ VEH√çCULO DISPONIBLE
            
            btnContinuePayment.disabled = false;
            btnContinuePayment.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>CONTINUE TO PAYMENT';
            btnContinuePayment.classList.remove('btn-secondary');
            btnContinuePayment.classList.add('btn-primary');
            
            // Agregar badge de disponibilidad en el resumen
            const statusBadge = document.createElement('div');
            statusBadge.className = 'alert alert-success mt-3 mb-0';
            statusBadge.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <strong>Status:</strong> AVAILABLE
            `;
            
            const vehicleInfoSection = summarySection.querySelector('.text-center.mb-4');
            if (vehicleInfoSection && !vehicleInfoSection.querySelector('.alert-success')) {
                vehicleInfoSection.appendChild(statusBadge);
            }
            
            console.log('‚úÖ Vehicle is available for reservation');
        }
    }

    /* ===============================================================
    4.2 DESHABILITAR FORMULARIO DE RESERVA
    ================================================================ */
    function disableReservationForm() {
        // Deshabilitar todos los campos del formulario excepto los readonly
        const form = document.getElementById('reservationForm');
        const inputs = form.querySelectorAll('input:not([readonly]), select');
        
        inputs.forEach(input => {
            input.disabled = true;
            input.style.opacity = '0.6';
            input.style.cursor = 'not-allowed';
        });
        
        // Deshabilitar datepickers
        if (typeof $ !== 'undefined' && $('#date-reserva').data('datetimepicker')) {
            $('#date-reserva').datetimepicker('disable');
        }
        if (typeof $ !== 'undefined' && $('#time-reserva').data('datetimepicker')) {
            $('#time-reserva').datetimepicker('disable');
        }
        
        console.log('‚ùå Reservation form disabled - vehicle not available');
    }

    /* ===============================================================
    5. CARGA DE ASESORES (TODOS)
    ================================================================ */
    function loadAllAdvisors() {
        fetch(API_URLS.advisors)
            .then(resp => {
                if (!resp.ok) throw new Error("Network error");
                return resp.json();
            })
            .then(json => {
                console.log('‚úÖ All advisors:', json);

                if (json.success && json.data && Array.isArray(json.data)) {
                    allAdvisors = json.data;
                } else {
                    showError("No advisors found.", false);
                }
            })
            .catch(error => {
                showError(`Error loading advisors: ${error.message}`, false);
                console.error('‚ùå Advisors error:', error);
            });
    }

    /* ===============================================================
    6. FILTRAR ASESORES POR DISPONIBILIDAD
    ================================================================ */
    async function filterAvailableAdvisors(date, time) {
        const select = document.getElementById('advisorSelect');
        select.innerHTML = '<option value="" disabled selected>Checking availability...</option>';
        select.disabled = true;

        try {
            // Obtener disponibilidad de TODOS los asesores
            const availabilityPromises = allAdvisors.map(advisor =>
                fetch(`${API_URLS.availability}?advisor_id=${advisor.advisor_id}`)
                    .then(r => r.json())
                    .then(data => ({
                        advisor_id: advisor.advisor_id,
                        full_name: advisor.full_name,
                        booked: data.success ? data.data : {}
                    }))
            );

            const advisorsWithAvailability = await Promise.all(availabilityPromises);

            // Filtrar solo los que NO tienen reserva en esa fecha/hora
            const availableAdvisors = advisorsWithAvailability.filter(advisor => {
                const bookedTimes = advisor.booked[date] || [];
                return !bookedTimes.includes(time);
            });

            console.log('‚úÖ Available advisors:', availableAdvisors);

            if (availableAdvisors.length === 0) {
                select.innerHTML = '<option value="" disabled selected>No advisors available for this time</option>';
                showError("All advisors are busy at this time. Please select another date/time.", false);
                document.getElementById('summaryAdvisorName').textContent = 'No advisors available';
                return;
            }

            // Llenar select con asesores disponibles
            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = `Select an advisor (${availableAdvisors.length} available)`;
            select.appendChild(defaultOption);

            availableAdvisors.forEach(advisor => {
                const option = document.createElement('option');
                option.value = advisor.advisor_id;
                option.textContent = advisor.full_name;
                option.setAttribute('data-name', advisor.full_name);
                select.appendChild(option);
            });

            select.disabled = false;

            // Event listener
            if (!advisorSelectInitialized) {
                select.addEventListener('change', handleAdvisorChange);
                advisorSelectInitialized = true;
            }

        } catch (error) {
            console.error('‚ùå Error checking availability:', error);
            showError("Error checking advisor availability.", false);
        }
    }

    function handleAdvisorChange(event) {
        const select = event.target;
        const advisorName = select.options[select.selectedIndex].getAttribute('data-name');
        document.getElementById('summaryAdvisorName').textContent = advisorName;
    }

    /* ===============================================================
    7. DATE/TIME PICKERS
    ================================================================ */
    function setupDateTimePickers() {
        if (typeof $ === 'undefined' || typeof $.fn.datetimepicker === 'undefined') {
            console.error('‚ùå jQuery or DateTimePicker not loaded');
            return;
        }

        // ‚úÖ Selector de Fecha
        $('#date-reserva').datetimepicker({
            format: 'YYYY-MM-DD',
            minDate: moment().add(1, 'day')
        });

        $('#date-reserva').on('change.datetimepicker', function (e) {
            const date = $('#dateReserva').val();

            if (date) {
                // Resetear hora y asesor
                $('#timeReserva').val('');
                document.getElementById('advisorSelect').innerHTML = '<option value="" disabled selected>Select time first</option>';
                document.getElementById('advisorSelect').disabled = true;
                document.getElementById('summaryDateTime').textContent = moment(date, 'YYYY-MM-DD').format('DD/MM/YYYY') + ' - Select Time';
                document.getElementById('summaryAdvisorName').textContent = 'Select Date & Time first';
            }
        });

        // ‚úÖ Selector de Hora (solo :00 y :30)
        $('#time-reserva').datetimepicker({
            format: 'HH:mm',
            enabledHours: allowedHours,
            stepping: 30
        });

        $('#time-reserva').on('change.datetimepicker', function (e) {
            const date = $('#dateReserva').val();
            const time = $('#timeReserva').val();

            if (date && time) {
                // Validar que solo sea :00 o :30
                const minutes = parseInt(time.split(':')[1]);
                if (!allowedMinutes.includes(minutes)) {
                    showError("Please select a time at :00 or :30 minutes.", false);
                    $('#timeReserva').val('');
                    return;
                }

                // Actualizar resumen
                const formattedDateTime = moment(date + ' ' + time, 'YYYY-MM-DD HH:mm').format('DD/MM/YYYY HH:mm');
                document.getElementById('summaryDateTime').textContent = formattedDateTime;

                // Filtrar asesores disponibles
                filterAvailableAdvisors(date, time);
            }
        });
    }

    /* ===============================================================
    8. L√ìGICA DE PAGO
    ================================================================ */
    function setupPaymentToggle() {
        const paymentMethodSelect = document.getElementById('paymentMethod');
        const cardDetailsDiv = document.getElementById('cardDetails');
        const transferDetailsDiv = document.getElementById('transferDetails');

        if (!paymentMethodSelect || !cardDetailsDiv || !transferDetailsDiv) {
            console.error('‚ùå Payment elements not found');
            return;
        }

        function togglePaymentFields() {
            const selectedMethod = paymentMethodSelect.value;

            cardDetailsDiv.style.display = 'none';
            transferDetailsDiv.style.display = 'none';

            cardDetailsDiv.querySelectorAll('input').forEach(input => {
                input.required = false;
                input.value = '';
            });
            transferDetailsDiv.querySelectorAll('input').forEach(input => {
                input.required = false;
                input.value = '';
            });

            if (selectedMethod === 'card') {
                cardDetailsDiv.style.display = 'block';
                cardDetailsDiv.querySelectorAll('input').forEach(input => input.required = true);
            } else if (selectedMethod === 'transfer') {
                transferDetailsDiv.style.display = 'block';
                transferDetailsDiv.querySelectorAll('input').forEach(input => input.required = true);
            }
        }

        paymentMethodSelect.addEventListener('change', togglePaymentFields);
        togglePaymentFields();
    }

    /* ===============================================================
    9. ENV√çO DEL FORMULARIO
    ================================================================ */
    function setupFormSubmission() {
        document.getElementById('reservationForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Validar campos de pago
            const paymentMethod = document.getElementById('paymentMethod').value;
            if (!paymentMethod) {
                showError("Please select a payment method.", false);
                return;
            }

            if (paymentMethod === 'card') {
                const cardNumber = document.querySelector('input[name="card_number"]').value;
                if (!cardNumber || cardNumber.replace(/\s/g, '').length < 13) {
                    showError("Please enter a valid card number.", false);
                    return;
                }
            } else if (paymentMethod === 'transfer') {
                const refNumber = document.querySelector('input[name="reference_number"]').value;
                if (!refNumber) {
                    showError("Please enter the transfer reference number.", false);
                    return;
                }
            }

            // Mostrar loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing reservation...';

            const formData = new FormData(this);

            fetch(API_URLS.createReservation, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // √âXITO
                        const statusText = 'pending verification';

                        Swal.fire({
                            icon: 'success',
                            title: '¬°Reservation Successful!',
                            html: `
                                <div class="text-left">
                                    <p><strong>Your reservation has been ${statusText}.</strong></p>
                                    <hr>
                                    <p><i class="fas fa-envelope mr-2"></i>You will receive a confirmation email shortly with:</p>
                                    <ul>
                                        <li>Vehicle details</li>
                                        <li>Appointment date and time</li>
                                        <li>Assigned advisor information</li>
                                        <li>Instructions for your visit</li>
                                    </ul>
                                    ${paymentMethod === 'transfer' ? '<p class="text-warning mt-3"><strong>Note:</strong> Your reservation will be confirmed once payment is verified.</p>' : ''}
                                </div>
                            `,
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#007bff',
                            allowOutsideClick: false
                        }).then(() => {
                            window.location.href = 'index.html';
                        });

                    } else {
                        // ERROR
                        Swal.fire({
                            icon: 'error',
                            title: 'Reservation Error',
                            text: data.message || 'Please try again or contact the dealership.',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Connection Error',
                        text: 'Could not connect to server. Please check your connection and try again.',
                        confirmButtonText: 'OK'
                    });
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
        });
    }

    /* ===============================================================
    10. FUNCIONES AUXILIARES
    ================================================================ */
    function showError(msg, isCritical) {
        const banner = document.getElementById('reservationBanner');
        banner.className = 'alert alert-' + (isCritical ? 'danger' : 'warning') + ' text-center';
        banner.innerHTML = `<strong>Error:</strong> ${msg}`;
        banner.style.display = 'block';

        // Auto-hide despu√©s de 5 segundos (solo para errores no cr√≠ticos)
        if (!isCritical) {
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }

        if (isCritical) {
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
        }
    }
    </script>
</body>
</html>