<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Vanguard Motors</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Free HTML Templates" name="keywords">
    <meta content="Free HTML Templates" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Rubik&display=swap" rel="stylesheet"> 

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Topbar Start -->
    <div class="container-fluid bg-dark py-3 px-lg-5 d-none d-lg-block">
        <div class="row">
            <div class="col-md-6 text-center text-lg-left mb-2 mb-lg-0">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body pr-3" href=""><i class="fa fa-phone-alt mr-2"></i>+57 000 00 00</a>
                    <span class="text-body">|</span>
                    <a class="text-body px-3" href=""><i class="fa fa-envelope mr-2"></i>VanguardMotors@concessionaire.co</a>
                    <a href="LogIn.html">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="20" fill=white class="bi bi-person-circle" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                          </svg>
                    </a>
                </div>
            </div>
            <div class="col-md-6 text-center text-lg-right">
                <div class="d-inline-flex align-items-center">
                    <a class="text-body px-3" href="https://www.facebook.com/tu-pagina" target="_blank">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a class="text-body px-3" href="https://www.twitter.com/tu-usuario" target="_blank">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a class="text-body px-3" href="https://www.linkedin.com/in/tu-perfil" target="_blank">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a class="text-body px-3" href="https://www.instagram.com/tu-usuario" target="_blank">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a class="text-body pl-3" href="https://www.youtube.com/tu-canal" target="_blank">
                        <i class="fab fa-youtube"></i>
                    </a>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->

    <!-- Navbar Start -->
    <div class="container-fluid position-relative nav-bar p-0">
        <div class="position-relative px-lg-5" style="z-index: 9;">
            <nav class="navbar navbar-expand-lg bg-secondary navbar-dark py-3 py-lg-0 pl-3 pl-lg-5">
                <a href="" class="navbar-brand">
                    <h1 class="text-uppercase text-primary mb-1">Vanguard Motors</h1>
                </a>
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-between px-3" id="navbarCollapse">
                    <div class="navbar-nav ml-auto py-0">
                        <a href="index.html" class="nav-item nav-link">Homepage</a>
                        <a href="car.html" class="nav-item nav-link">Vehicle catalog</a>
                        <!--<a href="contact.html" class="nav-item nav-link">Contact</a>-->
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    <!-- Page Header Start -->
    <div class="container-fluid page-header">
        <h1 class="display-3 text-uppercase text-white mb-3">Vehicle Reserve</h1>
        <div class="d-inline-flex text-white">
            <h6 class="text-uppercase m-0"><a class="text-white" href="index.html">Homepage</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0"><a class="text-white" href="car.html">Vehicle Catalog</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase m-0"><a class="text-white" href="detail.html">Vehicle Details</a></h6>
            <h6 class="text-body m-0 px-3">/</h6>
            <h6 class="text-uppercase text-body m-0">Vehicle Reserve</h6>
        </div>
    </div>
    <!-- Page Header Start -->

    <!-- Car Booking Start -->
    <div id="reservationBanner" class="alert alert-info text-center" role="alert" style="display:none; position:fixed; top:90px; left:50%; transform:translateX(-50%); z-index:1060; width:90%; max-width:600px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
    <strong>Processing...</strong> Please wait.
</div>

<div class="container-fluid pb-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <form id="reservationForm" method="POST" action="backend-scripts/create_reservation.php">
                    <input type="hidden" name="vehicle_id" value="">
                    <input type="hidden" name="type_trasaction" value="reservation">
                    <input type="hidden" name="person_id" value=""> 
                    <input type="hidden" name="payment_reason" value="reservation">
                    
                    <h2 class="mb-4 text-uppercase text-primary">1. Your personal data</h2>
                    <div class="mb-5 border-bottom pb-4">
                        <p class="alert alert-success">Your information is pre-filled. Please confirm your phone number.</p>
                        <div class="row">
                            <div class="col-6 form-group">
                                <label for="fullName">Full Name</label>
                                <input type="text" id="fullName" class="form-control p-4 bg-light" value="" name="full_name" readonly required="required">
                            </div>
                            <div class="col-6 form-group">
                                <label for="identification">Identification</label>
                                <input type="text" id="identification" class="form-control p-4 bg-light" value="" name="identification" readonly required="required">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" class="form-control p-4 bg-light" value="" name="email" readonly required="required">
                            </div>
                            <div class="col-6 form-group">
                                <label for="phone">Phone number<span class="text-danger">*</span></label>
                                <input type="tel" id="phone" class="form-control p-4" placeholder="Your phone number" name="phone" required="required">
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="mb-4 text-uppercase text-primary">2. Schedule your appointment</h2>
                    <div class="mb-5 border-bottom pb-4">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="advisorSelect">Select Advisor<span class="text-danger">*</span></label>
                                <select id="advisorSelect" class="custom-select px-4" style="height: 50px;" name="advisor_id" required>
                                    <option value="" disabled selected>Select an advisor</option>
                                </select>
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="reservationPrice">Reservation amount</label>
                                <input type="text" id="reservationPrice" class="form-control p-4 bg-light" value="20.000" readonly name="reservation_price">
                                <small class="form-text text-muted">Fixed non-refundable amount</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="dateReserva">Appointment date<span class="text-danger">*</span></label>
                                    <div class="date" id="date-reserva" data-target-input="nearest">
                                        <input type="text" id="dateReserva" class="form-control p-4 datetimepicker-input" placeholder="Date" data-target="#date-reserva" data-toggle="datetimepicker" name="appointment_date" required />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="timeReserva">Appointment time<span class="text-danger">*</span></label>
                                    <div class="time" id="time-reserva" data-target-input="nearest">
                                        <input type="text" id="timeReserva" class="form-control p-4 datetimepicker-input" placeholder="Time" data-target="#time-reserva" data-toggle="datetimepicker" name="appointment_time" required />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="mb-4 text-uppercase text-primary">3. Deposit payment ($20.000)</h2>
                    <div class="mb-5">
                        <div class="form-group">
                            <label for="paymentMethod">Payment method<span class="text-danger">*</span></label>
                            <select id="paymentMethod" class="custom-select px-4" style="height: 50px;" name="payment_method" required>
                                <option value="" disabled selected>Select an option</option>
                                <option value="card">Credit/Debit card</option>
                                <option value="transfer">Bank transfer</option>
                            </select>
                        </div>
                        <div id="cardDetails" style="display: none;">
                            <div class="alert alert-warning">
                                **SIMULACIÓN DE PAGO:** Los datos de la tarjeta se recogen únicamente para generar el ID de pago aleatorio (`gateway_reference`) en el Back-End.
                            </div>
                            <div class="row">
                                <div class="col-6 form-group">
                                    <input type="text" class="form-control p-4" placeholder="Card number" name="card_number">
                                </div>
                                <div class="col-3 form-group">
                                    <input type="text" class="form-control p-4" placeholder="MM/YY" name="card_expiry">
                                </div>
                                <div class="col-3 form-group">
                                    <input type="text" class="form-control p-4" placeholder="CVV" name="card_cvv">
                                </div>
                            </div>
                        </div>
                        <div id="transferDetails" style="display: none;">
                            <p class="alert alert-info">
                                **Transferencia Bancaria:** Realice el pago y su reserva estará en estado **PENDIENTE** hasta la verificación del número de referencia.
                            </p>
                            <div class="form-group">
                                <input type="text" class="form-control p-4" placeholder="Invoice reference number (Required)" name="proof_reference">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-block btn-primary py-3" type="submit">CONFIRM RESERVATION AND PAY</button>
                </form>
            </div>
            
            <div class="col-lg-4">
                <div class="bg-secondary p-5 mb-5">
                    <h4 class="text-primary mb-4 text-uppercase">Resumen de la Reserva</h4>
                    <div class="text-center mb-4 border-bottom pb-3">
                        <img id="summaryVehicleImage" class="img-fluid mb-3" src="img/car-rent-2.png" alt="Vehicle Image" style="max-height: 150px; object-fit: cover;">
                        
                        <h5 id="summaryVehicleModel" class="text-white text-uppercase mb-0">**Loading...**</h5>
                        <p id="summaryVehicleMeta" class="text-white-50">Year / Color</p>
                    </div>
                    <div class="mb-4 border-bottom pb-3">
                        <h6 class="text-white mb-2">Client: <span id="summaryCustomerName" class="float-right">Loading...</span></h6>
                        <h6 class="text-white mb-0">Assigned advisor: <span id="summaryAdvisorName" class="float-right text-success">Select Advisor</span></h6>
                        <h6 class="text-white mb-0 mt-2">Scheduled appointment: <span id="summaryDateTime" class="float-right text-warning">Select Date & Time</span></h6>
                    </div>
                    <div class="mb-4 border-bottom pb-3">
                        <h5 class="text-uppercase mb-3">Deposit details</h5>
                        <h6 class="text-white mb-2">Reservation amount: <span class="float-right text-success">**$20.000**</span></h6>
                        <h6 class="text-white mb-0 text-danger">Condition: <span class="float-right font-weight-bold">NON-REFUNDABLE</span></h6>
                    </div>
                    <div class="mb-4">
                        <h4 class="text-primary text-uppercase">Total to pay: <span class="float-right">$20.000</span></h4>
                    </div>
                    <p class="small text-white-50 text-center pt-3">This payment guarantees the reservation of the appointment space; it is non-refundable.</p>
                </div>
            </div>
        </div>
    </div>
</div>    
    <!--Car Booking End-->

    <!-- Vendor Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="owl-carousel vendor-carousel">
                <div class="bg-light p-4">
                    <img src="img/vendor-1.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-2.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-3.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-4.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-5.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-6.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-7.png" alt="">
                </div>
                <div class="bg-light p-4">
                    <img src="img/vendor-8.png" alt="">
                </div>
            </div>
        </div>
    </div>
    <!-- Vendor End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-secondary py-5 px-sm-3 px-md-5" style="margin-top: 90px;">
        <div class="row pt-5">
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Get In Touch</h4>
                <p class="mb-2"><i class="fa fa-map-marker-alt text-white mr-3"></i>Poblado, Medellín</p>
                <p class="mb-2"><i class="fa fa-phone-alt text-white mr-3"></i>+57 000 00 00</p>
                <p><i class="fa fa-envelope text-white mr-3"></i>info@concessionaire.co</p>
                <h6 class="text-uppercase text-white py-2">Follow Us</h6>
                <div class="d-flex justify-content-start">
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-twitter"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square mr-2" href="#"><i class="fab fa-linkedin-in"></i></a>
                    <a class="btn btn-lg btn-dark btn-lg-square" href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <!--usefull links: poner algunos servicios como mantenimiento, reparación y que redireccione directamente al chat de contactenos-->
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Usefull Links</h4>
                <div class="d-flex flex-column justify-content-start">
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Private Policy</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Term & Conditions</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>New Member Registration</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Affiliate Programme</a>
                    <a class="text-body mb-2" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Return & Refund</a>
                    <a class="text-body" href="#"><i class="fa fa-angle-right text-white mr-2"></i>Help & FQAs</a>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Vahicle Gallery</h4>
                <div class="row mx-n1">
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-1.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-2.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-3.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-4.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-5.jpg" alt=""></a>
                    </div>
                    <div class="col-4 px-1 mb-2">
                        <a href=""><img class="w-100" src="img/gallery-6.jpg" alt=""></a>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-5">
                <h4 class="text-uppercase text-light mb-4">Newsletter</h4>
                <p class="mb-4">If you see any problems with the page, please let us know or tell us about your experience with us.</p>
                <div class="w-100 mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark border-dark" style="padding: 25px;" placeholder="Write here">
                        <div class="input-group-append">
                            <button class="btn btn-primary text-uppercase px-3">Send</button>
                        </div>
                    </div>
                </div>
                <i>We will read your message instantly.</i>
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark py-4 px-sm-3 px-md-5">
        <p class="mb-2 text-center text-body">&copy; <a href="#">VanguardMotors</a>. All Rights Reserved.</p>
        <p class="m-0 text-center text-body">Designed by <a href="">K2ES SD</a></p>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
   <script>
    // Configuración de la Aplicación
    const RESERVATION_PRICE = 20000;
    const API_URLS = {
        vehicle: 'backend-scripts/get_vehicle_detail.php', 
        advisors: 'backend-scripts/get_advisors.php', 
        availability: 'backend-scripts/get_advisor_availability.php',
        userData: 'backend-scripts/get_logged_user_data.php'
    };

    let vehicleData = {};
    let clientData = {};
    let bookedDates = {}; 
    const defaultHours = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
    

    // =================================================================
    // 1. INICIALIZACIÓN Y CARGA DE DATOS AL CARGAR LA PÁGINA
    // =================================================================

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const vehicleId = urlParams.get('vehicle_id');

        if (!vehicleId) {
            showError("Error Crítico: No se proporcionó el ID del vehículo en la URL.", true);
            return;
        }

        // Ejecutar las funciones iniciales
        loadVehicleData(vehicleId);
        loadAdvisors();
        setupPaymentToggle();
        
        // ✅ Esperar a que jQuery y DateTimePicker estén listos
        $(document).ready(function() {
            setupDateTimePickers();
        });
        
        checkUserSessionAndLoadData(); 
    });


    // =================================================================
    // 2. CARGA DE DATOS DEL CLIENTE LOGUEADO (FETCH REAL)
    // =================================================================

    function checkUserSessionAndLoadData() {
        const banner = document.getElementById('reservationBanner');
        banner.innerHTML = '<strong>Cargando datos del usuario...</strong>';
        banner.className = 'alert alert-info text-center';
        banner.style.display = 'block';
        
        fetch(API_URLS.userData)
            .then(resp => {
                if (!resp.ok) throw new Error("Error de red");
                return resp.json();
            })
            .then(json => {
                console.log('Respuesta de usuario:', json);
                
                if (json.success && json.is_logged_in && json.data) {
                    clientData = json.data;
                    populateClientData(clientData);
                    banner.style.display = 'none';
                } else {
                    showError("Debe iniciar sesión para hacer una reserva.", true);
                }
            })
            .catch(error => {
                showError(`Error cargando datos del usuario: ${error.message}`, true);
                console.error('Error:', error);
            });
    }

    function populateClientData(data) {
        document.getElementById('fullName').value = data.full_name || 'N/A';
        document.getElementById('identification').value = data.identification || 'N/A';
        document.getElementById('email').value = data.email || 'N/A';
        
        if (document.getElementById('phone').value === '') { 
             document.getElementById('phone').value = data.phone || '';
        }
        
        document.querySelector('input[name="person_id"]').value = data.person_id || '';
        document.getElementById('summaryCustomerName').textContent = data.full_name || 'N/A';
        updateSummary();
    }


    // =================================================================
    // 3. CARGA DE DATOS DEL VEHÍCULO (FETCH REAL)
    // =================================================================

    function loadVehicleData(vehicleId) {
        document.getElementById('summaryVehicleModel').textContent = 'Cargando vehículo...';
        
        fetch(API_URLS.vehicle + '?vehicle_id=' + vehicleId) 
            .then(resp => {
                if (!resp.ok) throw new Error("Error de red");
                return resp.json();
            })
            .then(json => {
                console.log('Respuesta de vehículo:', json);
                
                if (json.success && json.data) {
                    vehicleData = json.data;
                    document.querySelector('input[name="vehicle_id"]').value = vehicleId;

                    const imageUrl = vehicleData.images && vehicleData.images.length > 0 
                                     ? vehicleData.images[0] 
                                     : 'img/car-placeholder.png';
                    
                    document.getElementById('summaryVehicleImage').src = imageUrl;
                    document.getElementById('summaryVehicleImage').alt = vehicleData.brand + ' ' + vehicleData.model;
                    document.getElementById('summaryVehicleModel').textContent = `${vehicleData.brand} ${vehicleData.model}`;
                    document.getElementById('summaryVehicleMeta').textContent = `Año ${vehicleData.year} / Color ${vehicleData.color}`;
                } else {
                    showError("Error: Vehículo no encontrado.", true);
                }
            })
            .catch(error => {
                showError(`Error cargando vehículo: ${error.message}`, true);
                console.error('Error:', error);
            });
    }


    // =================================================================
    // 4. CARGA DE ASESORES Y DISPONIBILIDAD (FETCH REAL)
    // =================================================================
    
    function loadAdvisors() {
        const select = document.getElementById('advisorSelect');
        select.innerHTML = '<option value="" disabled selected>Cargando asesores...</option>';
        
        fetch(API_URLS.advisors)
            .then(resp => {
                if (!resp.ok) throw new Error("Error de red");
                return resp.json();
            })
            .then(json => {
                console.log('Respuesta de asesores:', json);
                
                if (json.success && json.data && json.data.length > 0) {
                    select.innerHTML = '<option value="" disabled selected>Seleccione un asesor</option>';
                    json.data.forEach(advisor => {
                        const option = document.createElement('option');
                        option.value = advisor.advisor_id;
                        option.textContent = advisor.full_name;
                        option.setAttribute('data-name', advisor.full_name);
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="" disabled selected>No hay asesores disponibles</option>';
                    showError("No se encontraron asesores disponibles.", false);
                }
            })
            .catch(error => {
                showError(`Error cargando asesores: ${error.message}`, false);
                console.error('Error:', error);
            });

        // Event listener para cuando se selecciona un asesor
        select.addEventListener('change', handleAdvisorChange);
    }

    function handleAdvisorChange() {
        const select = document.getElementById('advisorSelect');
        const advisorId = select.value;
        const advisorName = select.options[select.selectedIndex].getAttribute('data-name');
        
        document.getElementById('summaryAdvisorName').textContent = advisorName;
        
        if (advisorId) {
            // Limpiar fecha y hora
            $('#dateReserva').val('');
            $('#timeReserva').val('');
            document.getElementById('summaryDateTime').textContent = 'Seleccione Fecha y Hora';
            
            loadAdvisorAvailability(advisorId);
        }
        updateSummary();
    }

    function loadAdvisorAvailability(advisorId) {
        const banner = document.getElementById('reservationBanner');
        banner.innerHTML = '<strong>Cargando disponibilidad...</strong>';
        banner.className = 'alert alert-info text-center';
        banner.style.display = 'block';

        fetch(API_URLS.availability + '?advisor_id=' + advisorId)
            .then(resp => {
                if (!resp.ok) throw new Error("Error de red");
                return resp.json();
            })
            .then(json => {
                console.log('Disponibilidad:', json);
                
                if (json.success) {
                    bookedDates = json.data || {}; 
                    
                    // ✅ Re-inicializar DateTimePickers con disponibilidad
                    $(document).ready(function() {
                        setupDateTimePickers(true);
                    });
                    
                    banner.style.display = 'none';
                } else {
                    showError("Error al cargar disponibilidad.", false);
                    bookedDates = {};
                }
            })
            .catch(error => {
                showError(`Error de disponibilidad: ${error.message}`, false);
                console.error('Error:', error);
                bookedDates = {};
            });
    }
    
    
    // =================================================================
    // 5. LÓGICA DE DATE/TIME PICKERS (Restricción de Horas)
    // =================================================================

    function setupDateTimePickers(reinit = false) {
        // ✅ Verificar que jQuery y DateTimePicker estén disponibles
        if (typeof $ === 'undefined' || typeof $.fn.datetimepicker === 'undefined') {
            console.error('jQuery o DateTimePicker no están cargados');
            return;
        }

        // Si ya está inicializado, destruir
        if (reinit) {
            try {
                const datePicker = $('#date-reserva').data("DateTimePicker");
                const timePicker = $('#time-reserva').data("DateTimePicker");
                if (datePicker) datePicker.destroy();
                if (timePicker) timePicker.destroy();
            } catch (e) {
                console.warn('Error al destruir pickers:', e);
            }
        }

        // ✅ Selector de Fecha
        $('#date-reserva').datetimepicker({
            format: 'YYYY-MM-DD',
            minDate: moment().add(1, 'day')
        });
        
        // Evento al cambiar fecha
        $('#date-reserva').on('change.datetimepicker', function(e) {
            updateSummary();
            $('#timeReserva').val('');
            const timePicker = $('#time-reserva').data("DateTimePicker");
            if (timePicker) {
                timePicker.clear();
                updateDisabledTimeIntervals();
            }
            document.getElementById('summaryDateTime').textContent = 'Seleccione Fecha y Hora';
        });

        // ✅ Selector de Hora
        $('#time-reserva').datetimepicker({
            format: 'HH:mm',
            enabledHours: defaultHours.map(h => parseInt(h.split(':')[0])), 
            stepping: 60
        });
        
        // Evento al cambiar hora
        $('#time-reserva').on('change.datetimepicker', function(e) {
            updateSummary();
        });

        // ✅ Actualizar horas deshabilitadas
        updateDisabledTimeIntervals();
    }

    // ✅ Actualizar intervalos de tiempo deshabilitados
    function updateDisabledTimeIntervals() {
        const selectedDate = $('#dateReserva').val();
        const timePicker = $('#time-reserva').data("DateTimePicker");
        
        if (!timePicker || !selectedDate) return;

        const reservedTimes = bookedDates[selectedDate] || [];
        
        // Crear intervalos deshabilitados (bloquear 1 hora completa)
        const intervals = reservedTimes.map(timeStr => {
            const [h, m] = timeStr.split(':').map(Number);
            const start = moment(selectedDate + ' ' + timeStr, 'YYYY-MM-DD HH:mm');
            const end = moment(start).add(59, 'minutes');
            return [start, end];
        });
        
        timePicker.disabledTimeIntervals(intervals);
    }
    
    
    // =================================================================
    // 6. LÓGICA DE PAGO Y RESUMEN
    // =================================================================

    function setupPaymentToggle() {
        const paymentMethodSelect = document.getElementById('paymentMethod');
        const cardDetailsDiv = document.getElementById('cardDetails');
        const transferDetailsDiv = document.getElementById('transferDetails');
        
        function togglePaymentFields() {
            const selectedMethod = paymentMethodSelect.value;
            
            cardDetailsDiv.style.display = 'none';
            transferDetailsDiv.style.display = 'none';
            
            cardDetailsDiv.querySelectorAll('input').forEach(input => {
                input.required = false;
                input.value = '';
            });
            transferDetailsDiv.querySelectorAll('input').forEach(input => {
                input.required = false;
                input.value = '';
            });

            if (selectedMethod === 'card') {
                cardDetailsDiv.style.display = 'block';
                cardDetailsDiv.querySelectorAll('input').forEach(input => input.required = true);
            } else if (selectedMethod === 'transfer') {
                transferDetailsDiv.style.display = 'block';
                transferDetailsDiv.querySelectorAll('input').forEach(input => input.required = true);
            }
        }
        
        paymentMethodSelect.addEventListener('change', togglePaymentFields);
        togglePaymentFields();
    }

    function updateSummary() {
        const date = document.getElementById('dateReserva').value;
        const time = document.getElementById('timeReserva').value;
        
        if (date && time) {
            const formattedDateTime = moment(date + ' ' + time, 'YYYY-MM-DD HH:mm').format('DD/MM/YYYY HH:mm');
            document.getElementById('summaryDateTime').textContent = formattedDateTime;
        } else if (date) {
            document.getElementById('summaryDateTime').textContent = moment(date, 'YYYY-MM-DD').format('DD/MM/YYYY') + ' - Seleccione Hora';
        } else {
            document.getElementById('summaryDateTime').textContent = 'Seleccione Fecha y Hora';
        }
    }

    function showError(msg, isCritical) {
        const banner = document.getElementById('reservationBanner');
        banner.className = 'alert alert-' + (isCritical ? 'danger' : 'warning') + ' text-center';
        banner.innerHTML = `<strong>Error:</strong> ${msg}`;
        banner.style.display = 'block';
        
        if (isCritical) {
            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;
        }
    }
</script>
</body>

</html>